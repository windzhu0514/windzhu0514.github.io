<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>goroutine并发控制 | 一蓑烟雨任平生</title>
    <meta property="og:title" content="goroutine并发控制 - 一蓑烟雨任平生">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2018-12-07T10:05:37&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2018-12-07T10:05:37&#43;08:00'>
        
    <meta name="Keywords" content="go,golang,go语言,博客,C,C&#43;&#43;,mfc">
    <meta name="description" content="goroutine并发控制">
        
    <meta name="author" content="风竹">
    <meta property="og:url" content="/post/go-goroutine-concurrent-control/">
    <link rel="shortcut icon" href="../../favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href='../../css/normalize.css'>
    <link rel="stylesheet" href='../../css/style.css'>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    


    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="../../">
                        一蓑烟雨任平生
                    </a>
                
                <p class="description">Go语言(golang)、C/C&#43;&#43;、MFC开发者</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="../../">首页</a>
                    
                    <a  href="../../about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">goroutine并发控制</h1>
        </header>
        <date class="post-meta meta-date">
            2018年12月7日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='../../categories/golang'>golang</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <h2 id="通信">通信</h2>
<h4 id="共享内存">共享内存</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">Test</span>() {
	<span style="color:#a6e22e">ordersInfoApp</span>  <span style="color:#f92672">:=</span>  make([]<span style="color:#a6e22e">orderInfoApp</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">totalCount</span>)
	<span style="color:#66d9ef">var</span>  <span style="color:#a6e22e">mux</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>
	<span style="color:#a6e22e">wg</span>  <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>{}

	<span style="color:#66d9ef">for</span>  <span style="color:#a6e22e">i</span>  <span style="color:#f92672">:=</span>  <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span>  <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">go</span>  <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">pageIndex</span> <span style="color:#66d9ef">int</span>) {
			<span style="color:#75715e">// do somethine
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">var</span>  <span style="color:#a6e22e">ordersInfo</span> <span style="color:#a6e22e">orderInfoApp</span>
			<span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">Lock</span>()
			<span style="color:#a6e22e">ordersInfoApp</span>  =  append(<span style="color:#a6e22e">ordersInfoApp</span>, <span style="color:#a6e22e">ordersInfo</span>)
			<span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">Unlock</span>()

			<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
		}(<span style="color:#a6e22e">i</span>)
	}

	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
}
</code></pre></div><p>一般在简单的数据传递下使用</p>
<h4 id="channel">channel</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">Test</span>() {
	<span style="color:#a6e22e">ordersInfoApp</span>  <span style="color:#f92672">:=</span>  make([]<span style="color:#a6e22e">orderInfoApp</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">totalCount</span>)
	<span style="color:#a6e22e">choi</span>  <span style="color:#f92672">:=</span>  make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">orderInfoApp</span>, <span style="color:#ae81ff">10</span>)
	<span style="color:#a6e22e">wg</span>  <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>{}

	<span style="color:#66d9ef">for</span>  <span style="color:#a6e22e">i</span>  <span style="color:#f92672">:=</span>  <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span>  <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">go</span>  <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">pageIndex</span> <span style="color:#66d9ef">int</span>) {
			<span style="color:#75715e">// do somethine
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">var</span>  <span style="color:#a6e22e">ordersInfo</span> <span style="color:#a6e22e">orderInfoApp</span>
			<span style="color:#a6e22e">choi</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ordersInfo</span>

			<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
		}(<span style="color:#a6e22e">i</span>)
	}

	<span style="color:#66d9ef">go</span>  <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
		close(<span style="color:#a6e22e">choi</span>)
	}()

	<span style="color:#66d9ef">for</span>  <span style="color:#a6e22e">v</span>  <span style="color:#f92672">:=</span>  <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">choi</span> {
		<span style="color:#a6e22e">ordersInfoApp</span>  =  append(<span style="color:#a6e22e">ordersInfoApp</span>, <span style="color:#a6e22e">v</span>)
	}
}
</code></pre></div><p>相对复杂的数据流动情况</p>
<h2 id="同步和控制">同步和控制</h2>
<p>goroutine 退出只能由本身控制，不能从外部强制结束该 goroutine
两种例外情况：main 函数结束或者程序崩溃结束运行</p>
<h4 id="共享变量控制结束">共享变量控制结束</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">running</span>  <span style="color:#f92672">:=</span>  <span style="color:#66d9ef">true</span>
	<span style="color:#a6e22e">f</span>  <span style="color:#f92672">:=</span>  <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">running</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;i am running&#34;</span>)
			<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span>  <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;exit&#34;</span>)
	}
	<span style="color:#66d9ef">go</span>  <span style="color:#a6e22e">f</span>()
	<span style="color:#66d9ef">go</span>  <span style="color:#a6e22e">f</span>()
	<span style="color:#66d9ef">go</span>  <span style="color:#a6e22e">f</span>()
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">2</span>  <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#a6e22e">running</span>  =  <span style="color:#66d9ef">false</span>
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">3</span>  <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;main exit&#34;</span>)
}
</code></pre></div><p><strong>优点</strong>：
实现简单，不抽象，方便，一个变量即可简单控制子 goroutine 的进行。
<strong>缺点</strong>:
结构只能是多读一写，不能适应结构复杂的设计，如果有多写，会出现数据同步问题，需要加锁或者使用 sync.atomic
不适合用于同级的子 go 程间的通信，全局变量传递的信息太少
因为是单向通知,主进程无法等待所有子 goroutine 退出
这种方法只适用于非常简单的逻辑且并发量不太大的场景</p>
<h4 id="syncwaitgroup-等待结束">sync.Waitgroup 等待结束</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">var</span>  <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
	<span style="color:#66d9ef">for</span>  <span style="color:#a6e22e">i</span>  <span style="color:#f92672">:=</span>  <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt;  <span style="color:#ae81ff">3</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">go</span>  <span style="color:#66d9ef">func</span>() {
			<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
			<span style="color:#75715e">// do something
</span><span style="color:#75715e"></span>		}()
	}

	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
}
</code></pre></div><h4 id="channel-控制结束">channel 控制结束</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// 可扩展到多个work
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">chClose</span>  <span style="color:#f92672">:=</span>  make(<span style="color:#66d9ef">chan</span>  <span style="color:#66d9ef">struct</span>{})
	<span style="color:#66d9ef">go</span>  <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">for</span> {
			<span style="color:#66d9ef">select</span> {
				<span style="color:#66d9ef">case</span>  <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">chClose</span>:
					<span style="color:#66d9ef">return</span>
				<span style="color:#66d9ef">default</span>:
			}

		<span style="color:#75715e">// do something
</span><span style="color:#75715e"></span>		}
	}()

	<span style="color:#75715e">//chClose&lt;-struct{}
</span><span style="color:#75715e"></span>	close(<span style="color:#a6e22e">chClose</span>)
}
</code></pre></div><p>注意 channel 的阻塞情况，避免出现死锁。
通常 channel 只能由发送者关闭</p>
<ul>
<li>
<p>向无缓冲的 channel 写入数据会导致该 goroutine 阻塞，直到其他 goroutine 从这个 channel 中读取数据</p>
</li>
<li>
<p>从无缓冲的 channel 读出数据，如果 channel 中无数据，会导致该 goroutine 阻塞，直到其他 goroutine 向这个 channel 中写入数据</p>
</li>
<li>
<p>向带缓冲的且缓冲已满的 channel 写入数据会导致该 goroutine 阻塞，直到其他 goroutine 从这个 channel 中读取数据</p>
</li>
<li>
<p>向带缓冲的且缓冲未满的 channel 写入数据不会导致该 goroutine 阻塞</p>
</li>
<li>
<p>从带缓冲的 channel 读出数据，如果 channel 中无数据，会导致该 goroutine 阻塞，直到其他 goroutine 向这个 channel 中写入数据</p>
</li>
<li>
<p>从带缓冲的 channel 读出数据，如果 channel 中有数据，该 goroutine 不会阻塞</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// 读完结束
</span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> {
  <span style="color:#66d9ef">select</span> {
  <span style="color:#66d9ef">case</span>  <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span>:
      <span style="color:#66d9ef">default</span>:
      <span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">finish</span>
  }
}
<span style="color:#a6e22e">finish</span>:
</code></pre></div></li>
<li>
<p>如果多个 case 同时就绪时，select 会随机地选择一个执行</p>
</li>
<li>
<p>case 标签里向 channel 发送或接收数据，case 后面的语句在发送接收成功后才会执行</p>
</li>
<li>
<p>nil channel（读、写、读写）的 case 标签会被跳过</p>
</li>
</ul>
<h4 id="limitwaitgroup">limitwaitgroup</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span>  <span style="color:#a6e22e">limitwaitgroup</span>  <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">sem</span> <span style="color:#66d9ef">chan</span>  <span style="color:#66d9ef">struct</span>{}
	<span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
}

<span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">n</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">limitwaitgroup</span> {
	<span style="color:#66d9ef">return</span>  <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">limitwaitgroup</span>{
		<span style="color:#a6e22e">sem</span>: make(<span style="color:#66d9ef">chan</span>  <span style="color:#66d9ef">struct</span>{}, <span style="color:#a6e22e">n</span>),
	}
}

<span style="color:#66d9ef">func</span>  (<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">limitwaitgroup</span>) <span style="color:#a6e22e">Add</span>() {
	<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">sem</span> <span style="color:#f92672">&lt;-</span>  <span style="color:#66d9ef">struct</span>{}{}
	<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
}

<span style="color:#66d9ef">func</span>  (<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">limitwaitgroup</span>) <span style="color:#a6e22e">Done</span>() {
	<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">sem</span>
	<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
}

<span style="color:#66d9ef">func</span>  (<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">limitwaitgroup</span>) <span style="color:#a6e22e">Wait</span>() {
	<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
}

<span style="color:#75715e">// 例子
</span><span style="color:#75715e"></span><span style="color:#a6e22e">wg</span>  <span style="color:#f92672">:=</span> <span style="color:#a6e22e">limitwaitgroup</span>.<span style="color:#a6e22e">New</span>(<span style="color:#ae81ff">6</span>)
<span style="color:#66d9ef">for</span>  <span style="color:#a6e22e">i</span>  <span style="color:#f92672">:=</span>  <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span>  <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>()
	<span style="color:#66d9ef">go</span>  <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">index</span> <span style="color:#66d9ef">int</span>){
		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
		<span style="color:#75715e">// do something
</span><span style="color:#75715e"></span>	}(<span style="color:#a6e22e">i</span>)
}
<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</code></pre></div><h4 id="context">context</h4>
<p>上下文 go 1.7 作为第一个参数在 goroutine 里传递</p>
<p>Context 的接口定义</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span>  <span style="color:#a6e22e">Context</span>  <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Deadline</span>() (<span style="color:#a6e22e">deadline</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>, <span style="color:#a6e22e">ok</span> <span style="color:#66d9ef">bool</span>)
	<span style="color:#a6e22e">Done</span>() <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span>  <span style="color:#66d9ef">struct</span>{}
	<span style="color:#a6e22e">Err</span>() <span style="color:#66d9ef">error</span>
	<span style="color:#a6e22e">Value</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">interface</span>{}
}
</code></pre></div><p><code>Deadline</code>获取设置的截止时间(WithDeadline、WithTimeout)， 第一个返回值代表截止时间，第二个返回值代表是否设置了截止时间，false 时表示没有设置截止时间</p>
<p><code>Done</code>方法返回一个关闭的只读的 chan，类型为<code>struct{}</code>，在 goroutine 中，如果该方法返回的 chan 可以读取，则意味着 parent context 已经发起了取消请求，我们通过<code>Done</code>方法收到这个信号后，就应该做清理操作，然后退出 goroutine，释放资源。</p>
<p><code>Err</code>context 没有被结束，返回 nil；已被结束，返回结束的原因（被取消、超时）。</p>
<p><code>Value</code>方法通过一个 Key 获取该 Context 上绑定的值，访问这个值是线程安全的。key 一般定义当前包的一个新的未导出类型的变量（最好不要使用内置类型），避免和其他 goroutine 的 key 冲突。</p>
<ul>
<li>Context 衍生</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">WithCancel</span>(<span style="color:#a6e22e">parent</span> <span style="color:#a6e22e">Context</span>) (<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#a6e22e">CancelFunc</span>)
<span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">WithDeadline</span>(<span style="color:#a6e22e">parent</span> <span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">deadline</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>) (<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">CancelFunc</span>)
<span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">parent</span> <span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">timeout</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>) (<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">CancelFunc</span>)
<span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">WithValue</span>(<span style="color:#a6e22e">parent</span> <span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">val</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#a6e22e">Context</span>
</code></pre></div><p>这四个<code>With</code>函数，接收的都有一个 partent 参数，就是父 Context，我们要基于这个父 Context 创建出子 Context 的意思，这种方式可以理解为子 Context 对父 Context 的继承，也可以理解为基于父 Context 的衍生。</p>
<p>通过这些函数，就创建了一颗 Context 树，树的每个节点都可以有任意多个子节点，节点层级可以有任意多个。</p>
<p><code>WithCancel</code>函数，传递一个父 Context 作为参数，返回子 Context，以及一个取消函数用来取消 Context。 <code>WithDeadline</code>函数，和<code>WithCancel</code>差不多，它会多传递一个截止时间参数，意味着到了这个时间点，会自动取消 Context，也可以不等到这个时候，可以提前通过取消函数进行取消。</p>
<p><code>WithTimeout</code>和<code>WithDeadline</code>基本上一样，这个表示是超时自动取消，设置多少时间后自动取消 Context。</p>
<p><code>WithValue</code>函数和取消 Context 无关，生成一个绑定了一个键值对数据的 Context，这个绑定的数据可以通过<code>Context.Value</code>方法访问到</p>
<ul>
<li>例子</li>
</ul>
<p>WithCancel</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span>  <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithCancel</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>())
	<span style="color:#66d9ef">go</span>  <span style="color:#a6e22e">watch</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;goroutine 1&#34;</span>)
	<span style="color:#66d9ef">go</span>  <span style="color:#a6e22e">watch</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;goroutine 2&#34;</span>)
	<span style="color:#66d9ef">go</span>  <span style="color:#a6e22e">watch</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;goroutine 3&#34;</span>)
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span>  <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;开始结束goroutine&#34;</span>)
	<span style="color:#a6e22e">cancel</span>()
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">5</span>  <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Err</span>())
}
<span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">watch</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) {
  <span style="color:#66d9ef">for</span> {
      <span style="color:#66d9ef">select</span> {
      <span style="color:#66d9ef">case</span>  <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():
          <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">name</span>, <span style="color:#e6db74">&#34;over&#34;</span>)
          <span style="color:#66d9ef">return</span>
      <span style="color:#66d9ef">default</span>:
          <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">name</span>, <span style="color:#e6db74">&#34;running&#34;</span>)
          <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">2</span>  <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
      }
  }
}

<span style="color:#75715e">// output:
</span><span style="color:#75715e"></span><span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">开始结束goroutine</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">over</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">over</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">over</span>
<span style="color:#a6e22e">context</span> <span style="color:#a6e22e">canceled</span>
</code></pre></div><p>WithDeadline</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span>  <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithDeadline</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>))
	<span style="color:#66d9ef">go</span>  <span style="color:#a6e22e">watch</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;goroutine 1&#34;</span>)
	<span style="color:#66d9ef">go</span>  <span style="color:#a6e22e">watch</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;goroutine 2&#34;</span>)
	<span style="color:#66d9ef">go</span>  <span style="color:#a6e22e">watch</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;goroutine 3&#34;</span>)
	<span style="color:#a6e22e">_</span>  = <span style="color:#a6e22e">cancel</span>
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">8</span>  <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Err</span>())
}

<span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">watch</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) {
  <span style="color:#66d9ef">for</span> {
      <span style="color:#66d9ef">select</span> {
      <span style="color:#66d9ef">case</span>  <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():
          <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">name</span>, <span style="color:#e6db74">&#34;over&#34;</span>)
          <span style="color:#66d9ef">return</span>
      <span style="color:#66d9ef">default</span>:
          <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">name</span>, <span style="color:#e6db74">&#34;running&#34;</span>)
          <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">2</span>  <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
      }
  }
}

<span style="color:#75715e">// output:
</span><span style="color:#75715e"></span><span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">over</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">over</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">over</span>
<span style="color:#a6e22e">context</span> <span style="color:#a6e22e">deadline</span> <span style="color:#a6e22e">exceeded</span>
</code></pre></div><p>WithTimeout</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span>  <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#66d9ef">go</span>  <span style="color:#a6e22e">watch</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;goroutine 1&#34;</span>)
	<span style="color:#66d9ef">go</span>  <span style="color:#a6e22e">watch</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;goroutine 2&#34;</span>)
	<span style="color:#66d9ef">go</span>  <span style="color:#a6e22e">watch</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;goroutine 3&#34;</span>)
	<span style="color:#a6e22e">_</span>  = <span style="color:#a6e22e">cancel</span>
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">8</span>  <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Err</span>())
}

<span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">watch</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) {
  <span style="color:#66d9ef">for</span> {
      <span style="color:#66d9ef">select</span> {
      <span style="color:#66d9ef">case</span>  <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():
          <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">name</span>, <span style="color:#e6db74">&#34;over&#34;</span>)
          <span style="color:#66d9ef">return</span>
      <span style="color:#66d9ef">default</span>:
          <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">name</span>, <span style="color:#e6db74">&#34;running&#34;</span>)
          <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">2</span>  <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
      }
  }
}

<span style="color:#75715e">// output:
</span><span style="color:#75715e"></span><span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">running</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">over</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">over</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">over</span>
<span style="color:#a6e22e">context</span> <span style="color:#a6e22e">deadline</span> <span style="color:#a6e22e">exceeded</span>
</code></pre></div><p>WithValue</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span>  <span style="color:#a6e22e">key</span>  <span style="color:#66d9ef">int</span>  <span style="color:#75715e">// 未导出的包私有类型
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span>  <span style="color:#a6e22e">kkk</span> <span style="color:#a6e22e">key</span> =  <span style="color:#ae81ff">0</span>

<span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span>  <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithCancel</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>())
	<span style="color:#75715e">// WithValue是没有取消函数的
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ctx</span>  = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithValue</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">kkk</span>, <span style="color:#e6db74">&#34;100W&#34;</span>)

	<span style="color:#66d9ef">go</span>  <span style="color:#a6e22e">watch</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;goroutine 1&#34;</span>)
	<span style="color:#66d9ef">go</span>  <span style="color:#a6e22e">watch</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;goroutine 2&#34;</span>)
	<span style="color:#66d9ef">go</span>  <span style="color:#a6e22e">watch</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;goroutine 3&#34;</span>)

	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">8</span>  <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)

	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;开始结束goroutine&#34;</span>)
	<span style="color:#a6e22e">cancel</span>()

	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">3</span>  <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Err</span>())
}

<span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">watch</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) {
  <span style="color:#66d9ef">for</span> {
      <span style="color:#66d9ef">select</span> {
      <span style="color:#66d9ef">case</span>  <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():
          <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">name</span>, <span style="color:#e6db74">&#34;over&#34;</span>)
          <span style="color:#66d9ef">return</span>
      <span style="color:#66d9ef">default</span>:
          <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">name</span>, <span style="color:#e6db74">&#34;running&#34;</span>, <span style="color:#e6db74">&#34;爸爸给我了&#34;</span>, <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Value</span>(<span style="color:#a6e22e">kkk</span>).(<span style="color:#66d9ef">string</span>))
          <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">2</span>  <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
      }
  }
}
<span style="color:#75715e">// output:
</span><span style="color:#75715e"></span><span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">running</span> <span style="color:#a6e22e">爸爸给我了</span> <span style="color:#ae81ff">100</span><span style="color:#a6e22e">W</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">running</span> <span style="color:#a6e22e">爸爸给我了</span> <span style="color:#ae81ff">100</span><span style="color:#a6e22e">W</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">running</span> <span style="color:#a6e22e">爸爸给我了</span> <span style="color:#ae81ff">100</span><span style="color:#a6e22e">W</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">running</span> <span style="color:#a6e22e">爸爸给我了</span> <span style="color:#ae81ff">100</span><span style="color:#a6e22e">W</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">running</span> <span style="color:#a6e22e">爸爸给我了</span> <span style="color:#ae81ff">100</span><span style="color:#a6e22e">W</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">running</span> <span style="color:#a6e22e">爸爸给我了</span> <span style="color:#ae81ff">100</span><span style="color:#a6e22e">W</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">running</span> <span style="color:#a6e22e">爸爸给我了</span> <span style="color:#ae81ff">100</span><span style="color:#a6e22e">W</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">running</span> <span style="color:#a6e22e">爸爸给我了</span> <span style="color:#ae81ff">100</span><span style="color:#a6e22e">W</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">running</span> <span style="color:#a6e22e">爸爸给我了</span> <span style="color:#ae81ff">100</span><span style="color:#a6e22e">W</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">running</span> <span style="color:#a6e22e">爸爸给我了</span> <span style="color:#ae81ff">100</span><span style="color:#a6e22e">W</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">running</span> <span style="color:#a6e22e">爸爸给我了</span> <span style="color:#ae81ff">100</span><span style="color:#a6e22e">W</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">running</span> <span style="color:#a6e22e">爸爸给我了</span> <span style="color:#ae81ff">100</span><span style="color:#a6e22e">W</span>
<span style="color:#a6e22e">开始结束goroutine</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">over</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">over</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">running</span> <span style="color:#a6e22e">爸爸给我了</span> <span style="color:#ae81ff">100</span><span style="color:#a6e22e">W</span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">over</span>
<span style="color:#a6e22e">context</span> <span style="color:#a6e22e">canceled</span>
</code></pre></div><p>控制多个 goroutine</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">W</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;收到请求&#34;</span>)

	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span>  <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithCancel</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>())
	<span style="color:#66d9ef">go</span>  <span style="color:#a6e22e">worker</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#ae81ff">2</span>)
	<span style="color:#66d9ef">go</span>  <span style="color:#a6e22e">worker</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#ae81ff">3</span>)

	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span>  <span style="color:#ae81ff">10</span>)
	<span style="color:#a6e22e">cancel</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Err</span>())
	})
	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:9290&#34;</span>, <span style="color:#66d9ef">nil</span>)
}
<span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">worker</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">speed</span> <span style="color:#66d9ef">int</span>) {
	<span style="color:#a6e22e">reader</span>  <span style="color:#f92672">:=</span>  <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">n</span> <span style="color:#66d9ef">int</span>) {
		<span style="color:#66d9ef">for</span> {
			<span style="color:#66d9ef">select</span> {
				<span style="color:#66d9ef">case</span>  <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():
				<span style="color:#66d9ef">return</span>
				<span style="color:#66d9ef">default</span>:
				<span style="color:#66d9ef">break</span>
			}
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;reader:&#34;</span>, <span style="color:#a6e22e">n</span>)
			<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>(<span style="color:#a6e22e">n</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
		}
	}

	<span style="color:#66d9ef">go</span>  <span style="color:#a6e22e">reader</span>(<span style="color:#ae81ff">2</span>)
	<span style="color:#66d9ef">go</span>  <span style="color:#a6e22e">reader</span>(<span style="color:#ae81ff">1</span>)

	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
			<span style="color:#66d9ef">case</span>  <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():
			<span style="color:#66d9ef">return</span>
			<span style="color:#66d9ef">default</span>:
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;worker:&#34;</span>, <span style="color:#a6e22e">speed</span>)
		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>(<span style="color:#a6e22e">speed</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	}
}

<span style="color:#75715e">// output:
</span><span style="color:#75715e"></span><span style="color:#a6e22e">收到请求</span>
<span style="color:#a6e22e">worker</span>: <span style="color:#ae81ff">2</span>
<span style="color:#a6e22e">reader</span>: <span style="color:#ae81ff">1</span>
<span style="color:#a6e22e">worker</span>: <span style="color:#ae81ff">3</span>
<span style="color:#a6e22e">reader</span>: <span style="color:#ae81ff">1</span>
<span style="color:#a6e22e">reader</span>: <span style="color:#ae81ff">2</span>
<span style="color:#a6e22e">reader</span>: <span style="color:#ae81ff">2</span>
<span style="color:#a6e22e">reader</span>: <span style="color:#ae81ff">1</span>
<span style="color:#a6e22e">reader</span>: <span style="color:#ae81ff">1</span>
<span style="color:#a6e22e">reader</span>: <span style="color:#ae81ff">1</span>
<span style="color:#a6e22e">reader</span>: <span style="color:#ae81ff">2</span>
<span style="color:#a6e22e">worker</span>: <span style="color:#ae81ff">2</span>
<span style="color:#a6e22e">reader</span>: <span style="color:#ae81ff">2</span>
<span style="color:#a6e22e">reader</span>: <span style="color:#ae81ff">1</span>
<span style="color:#a6e22e">reader</span>: <span style="color:#ae81ff">1</span>
<span style="color:#a6e22e">reader</span>: <span style="color:#ae81ff">1</span>
<span style="color:#a6e22e">worker</span>: <span style="color:#ae81ff">3</span>
<span style="color:#a6e22e">reader</span>: <span style="color:#ae81ff">1</span>
<span style="color:#a6e22e">worker</span>: <span style="color:#ae81ff">2</span>
<span style="color:#a6e22e">reader</span>: <span style="color:#ae81ff">2</span>
<span style="color:#a6e22e">reader</span>: <span style="color:#ae81ff">1</span>
<span style="color:#a6e22e">reader</span>: <span style="color:#ae81ff">2</span>
<span style="color:#a6e22e">reader</span>: <span style="color:#ae81ff">1</span>
<span style="color:#a6e22e">context</span> <span style="color:#a6e22e">canceled</span>
</code></pre></div><ul>
<li>
<p>使用规则
使用 Context 的程序应遵循以下这些规则来保持跨包接口的一致和方便静态分析工具(go vet)来检查上下文传播是否有潜在问题。</p>
<ul>
<li>
<p>不要将 Context 存储在结构类型中，而是显式的传递给每个需要的函数； Context 应该作为函数的第一个参数传递，通常命名为 ctx：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#66d9ef">func</span>  <span style="color:#a6e22e">DoSomething</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">arg</span> <span style="color:#a6e22e">Arg</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#75715e">// ... use ctx ...
</span><span style="color:#75715e"></span>}
</code></pre></div></li>
<li>
<p>即使函数可以接受 nil 值，也不要传递 nil Context。如果不确定要使用哪个 Context，请传递 context.TODO。</p>
</li>
<li>
<p>使用 context 的 Value 相关方法只应该用于在程序和接口中传递和请求相关的元数据，不要用它来传递一些可选的参数</p>
</li>
<li>
<p>相同的 Context 可以传递给在不同 goroutine 中运行的函数; Context 对于多个 goroutine 同时使用是安全的。</p>
</li>
</ul>
</li>
</ul>

        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="../../post/go-get-progress/">go get添加进度</a></li>
        
        <li><a href="../../post/markdown/">Markdown 基本语法</a></li>
        
        <li><a href="../../about/">关于我</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='../../tags/go'>go</a></li>
                
                <li><a href='../../tags/goroutine'>goroutine</a></li>
                
                <li><a href='../../tags/%E5%B9%B6%E5%8F%91'>并发</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "windzhu0514/windzhu0514.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='//www.google.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="../../post/go-time-rate/" title="Go Rate限流器代码分析">Go Rate限流器代码分析</a>
    </li>
    
    <li>
        <a href="../../post/website-caddy-hugo-filebrowser/" title="caddy-hugo-filebrowser搭建个人网站和后台管理">caddy-hugo-filebrowser搭建个人网站和后台管理</a>
    </li>
    
    <li>
        <a href="../../post/go-vscode-remote-development/" title="VSCode Remote Development-go开发环境搭建">VSCode Remote Development-go开发环境搭建</a>
    </li>
    
    <li>
        <a href="../../post/likaifu-10-gifts/" title="李开复：留学带给我的十件礼物，第一件是自信">李开复：留学带给我的十件礼物，第一件是自信</a>
    </li>
    
    <li>
        <a href="../../post/go-type-convert/" title="golang类型转换">golang类型转换</a>
    </li>
    
    <li>
        <a href="../../post/multiple-git-account/" title="git多账户共存">git多账户共存</a>
    </li>
    
    <li>
        <a href="../../post/go-goroutine-concurrent-control/" title="goroutine并发控制">goroutine并发控制</a>
    </li>
    
    <li>
        <a href="../../post/go-get-progress/" title="go get添加进度">go get添加进度</a>
    </li>
    
    <li>
        <a href="../../post/markdown/" title="Markdown 基本语法">Markdown 基本语法</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
    <li><a href="../../categories/git/">git (1)</a></li>
    
    <li><a href="../../categories/golang/">golang (6)</a></li>
    
    <li><a href="../../categories/markdown/">markdown (1)</a></li>
    
    <li><a href="../../categories/%E5%A5%BD%E6%96%87/">好文 (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
    <a href="../../tags/caddy/">caddy</a>
    
    <a href="../../tags/docker/">docker</a>
    
    <a href="../../tags/filebrowser/">filebrowser</a>
    
    <a href="../../tags/git/">git</a>
    
    <a href="../../tags/go/">go</a>
    
    <a href="../../tags/golang/">golang</a>
    
    <a href="../../tags/goroutine/">goroutine</a>
    
    <a href="../../tags/hugo/">hugo</a>
    
    <a href="../../tags/markdown/">markdown</a>
    
    <a href="../../tags/rate/">rate</a>
    
    <a href="../../tags/ssh/">ssh</a>
    
    <a href="../../tags/%E4%BA%BA%E7%94%9F/">人生</a>
    
    <a href="../../tags/%E4%BB%A4%E7%89%8C%E6%A1%B6/">令牌桶</a>
    
    <a href="../../tags/%E5%8A%B1%E5%BF%97/">励志</a>
    
    <a href="../../tags/%E5%B9%B6%E5%8F%91/">并发</a>
    
    <a href="../../tags/%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/">类型转换</a>
    
    <a href="../../tags/%E7%BD%91%E7%AB%99/">网站</a>
    
    <a href="../../tags/%E9%99%90%E6%B5%81%E5%99%A8/">限流器</a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="../../index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div class="container">
        &copy; 2020 <a href="../../">一蓑烟雨任平生 By 风竹</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="https://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/flysnow-org/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


<a id="rocket" href="#top"></a>
<script type="text/javascript" src='../../js/totop.js?v=0.0.0' async=""></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




</body>

</html>